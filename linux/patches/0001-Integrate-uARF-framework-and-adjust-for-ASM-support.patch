From 47b147b9359aab1add46cb9cea89b6667bd5c16e Mon Sep 17 00:00:00 2001
From: Jean-Claude Graf <mail@jeanclaudegraf.ch>
Date: Fri, 7 Feb 2025 10:45:24 +0100
Subject: [PATCH 1/2] Integrate uARF framework and adjust for ASM support

Test files can now have ASM files alongside them

The path of the symlinks needs to be adjusted according to the setup
---
 tools/testing/selftests/kvm/Makefile     | 17 ++++++++++++++---
 tools/testing/selftests/kvm/include/uarf |  1 +
 tools/testing/selftests/kvm/lib/uarf     |  1 +
 3 files changed, 16 insertions(+), 3 deletions(-)
 create mode 120000 tools/testing/selftests/kvm/include/uarf
 create mode 120000 tools/testing/selftests/kvm/lib/uarf

diff --git a/tools/testing/selftests/kvm/Makefile b/tools/testing/selftests/kvm/Makefile
index a3bb36fb3cfc..11206198c04a 100644
--- a/tools/testing/selftests/kvm/Makefile
+++ b/tools/testing/selftests/kvm/Makefile
@@ -136,6 +136,10 @@ TEST_GEN_PROGS_x86_64 += steal_time
 TEST_GEN_PROGS_x86_64 += kvm_binary_stats_test
 TEST_GEN_PROGS_x86_64 += system_counter_offset_test
 
+# TEST_GEN_PROGS_x86_64 += x86_64/rev_eng/hello_world
+# TEST_GEN_FILES += x86_64/rev_eng/hello_world_asm.o
+
+
 # Compiled outputs used by test targets
 TEST_GEN_PROGS_EXTENDED_x86_64 += x86_64/nx_huge_pages_test
 
@@ -232,6 +236,9 @@ pgste-option = $(call try-run, echo 'int main(void) { return 0; }' | \
 LDLIBS += -ldl
 LDFLAGS += -pthread $(no-pie-option) $(pgste-option)
 
+LDFLAGS += -L./lib/uarf
+LDLIBS += -luarf
+
 LIBKVM_C := $(filter %.c,$(LIBKVM))
 LIBKVM_S := $(filter %.S,$(LIBKVM))
 LIBKVM_C_OBJ := $(patsubst %.c, $(OUTPUT)/%.o, $(LIBKVM_C))
@@ -248,8 +255,12 @@ TEST_DEP_FILES += $(patsubst %.o, %.d, $(LIBKVM_OBJS))
 TEST_DEP_FILES += $(patsubst %.o, %.d, $(SPLIT_TESTS_OBJS))
 -include $(TEST_DEP_FILES)
 
-$(TEST_GEN_PROGS) $(TEST_GEN_PROGS_EXTENDED): %: %.o
-	$(CC) $(CFLAGS) $(CPPFLAGS) $(LDFLAGS) $(TARGET_ARCH) $< $(LIBKVM_OBJS) $(LDLIBS) -o $@
+%.o: %.S
+	$(CC) -c $(CFLAGS) $(CPPFLAGS) $(ASFLAGS) $(LDFLAGS) $(TARGET_ARCH) $< $(LDLIBS) -D__ASSEMBLY__ -o $@
+
+$(TEST_GEN_PROGS) $(TEST_GEN_PROGS_EXTENDED): %: %.o $(TEST_GEN_FILES)
+	$(CC) $(CFLAGS) $(CPPFLAGS) $(LDFLAGS) $(TARGET_ARCH) $(TEST_GEN_FILES) $< $(LIBKVM_OBJS) $(LDLIBS) -o $@
+
 $(TEST_GEN_OBJ): $(OUTPUT)/%.o: %.c
 	$(CC) $(CFLAGS) $(CPPFLAGS) $(TARGET_ARCH) -c $< -o $@
 
@@ -263,7 +274,7 @@ $(LIBKVM_C_OBJ): $(OUTPUT)/%.o: %.c
 	$(CC) $(CFLAGS) $(CPPFLAGS) $(TARGET_ARCH) -c $< -o $@
 
 $(LIBKVM_S_OBJ): $(OUTPUT)/%.o: %.S
-	$(CC) $(CFLAGS) $(CPPFLAGS) $(TARGET_ARCH) -c $< -o $@
+	$(CC) $(CFLAGS) $(CPPFLAGS) $(TARGET_ARCH) -c $< $(LDLIBS) -o $@
 
 # Compile the string overrides as freestanding to prevent the compiler from
 # generating self-referential code, e.g. without "freestanding" the compiler may
diff --git a/tools/testing/selftests/kvm/include/uarf b/tools/testing/selftests/kvm/include/uarf
new file mode 120000
index 000000000000..b20627674276
--- /dev/null
+++ b/tools/testing/selftests/kvm/include/uarf
@@ -0,0 +1 @@
+/home/jeanclaude/Documents/Studies/Eth/Semester11/MasterThesis/Code/uARF/include
\ No newline at end of file
diff --git a/tools/testing/selftests/kvm/lib/uarf b/tools/testing/selftests/kvm/lib/uarf
new file mode 120000
index 000000000000..00f664018314
--- /dev/null
+++ b/tools/testing/selftests/kvm/lib/uarf
@@ -0,0 +1 @@
+/home/jeanclaude/Documents/Studies/Eth/Semester11/MasterThesis/Code/uARF
\ No newline at end of file
-- 
2.48.1


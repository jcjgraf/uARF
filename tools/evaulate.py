#!/usr/bin/env python
import statistics

vmexit_baseline = """
12310.6, 12317.2, 12300.7, 12307.2, 12291.0
 3968.8,  3968.2,  3970.5,  3969.7,  3970.1
 1180.9,  1172.6,  1185.2,  1169.3,  1163.8
  123.2,   108.9,   128.9,   117.2,   113.9
   74.1,    66.5,    75.2,    69.0,    70.2
  323.0,   277.5,   315.1,   303.6,   304.7
 5646.2,  5657.7,  5652.1,  5632.0,  5626.7
 2366.0,  2372.2,  2365.0,  2365.7,  2367.7
 4752.6,  4649.3,  4630.9,  4607.8,  4515.9
 2939.8,  2928.9,  2929.9,  2914.0,  2925.1
 3412.3,  3401.4,  3401.6,  3392.0,  3398.4
 5075.5,  5064.8,  5068.9,  5082.4,  5080.1
=======,========,========,========,========
 1691.7,  1634.2,  1692.6,  1658.3,  1654.3
"""

vmexit_ibpb = """
12216.0 ,12213.8 ,12210.7, 12205.0 ,12174.5
 3934.2 , 3931.4 , 3931.0,  3928.0 , 3928.1
  594.1 ,  588.2 ,  599.2,   597.4 ,  604.9
   37.1 ,   36.5 ,   36.7,    36.8 ,   38.5
   22.3 ,   21.9 ,   22.2,    22.2 ,   23.4
   97.6 ,   97.8 ,   96.4,    97.2 ,  102.0
 5629.5 , 5633.3 , 5625.6,  5640.4 , 5641.0
 2372.1 , 2366.0 , 2374.8,  2378.3 , 2357.9
 4359.4 , 4376.2 , 4477.7,  4442.7 , 4427.0
 1515.6 , 1514.2 , 1519.9,  1515.1 , 1518.5
 1866.7 , 1866.3 , 1861.5,  1866.4 , 1856.3
 5136.3 , 5139.8 , 5135.4,  5132.8 , 5137.4
========,========,=======,=========,=======
 1057.2 , 1053.5 , 1057.9,  1058.1 , 1070.4
"""

qemu_baseline = """
 12092.7,  12100.6,  12057.9,  12104.6,  12146.0
  3931.4,   3940.9,   3933.8,   3943.5,   3937.5
  1134.6,   1136.6,   1124.2,   1133.8,   1123.2
   101.0,    101.8,    101.6,    102.4,    102.6
    59.7,     61.2,     59.8,     60.1,     61.1
   269.8,    270.6,    266.4,    271.4,    273.7
  5642.5,   5615.0,   5623.8,   5613.2,   5624.3
  2401.0,   2401.4,   2399.5,   2397.4,   2392.0
  4730.2,   4660.7,   4665.7,   4541.2,   4631.8
  2845.6,   2845.2,   2844.2,   2845.4,   2834.0
  3308.6,   3303.8,   3308.7,   3309.2,   3301.1
  5062.5,   5082.9,   5048.5,   5050.9,   5079.4
========, ========, ========, ========, ========
  1593.5,   1596.6,   1588.6,   1590.9,   1595.9
"""

qemu_retpoline = """
 12167.6, 12193.6, 12194.6, 12181.7, 12117.6
  3938.5,  3939.5,  3932.0,  3929.2,  3934.8
  1019.9,  1017.6,  1018.6,  1019.4,  1028.7
   104.0,   101.2,    90.5,    96.4,    99.1
    57.6,    59.0,    52.9,    58.4,    57.5
   249.0,   241.5,   229.5,   245.9,   242.0
  5606.9,  5615.9,  5634.0,  5627.0,  5612.1
  2390.0,  2389.1,  2381.3,  2394.6,  2384.3
  4530.6,  4635.8,  4564.2,  4601.0,  4621.5
  2605.2,  2600.7,  2600.1,  2604.1,  2595.5
  3084.3,  3080.2,  3081.3,  3084.0,  3077.2
  5084.5,  5085.2,  5087.7,  5108.6,  5058.1
========,========,========,========,========
  1542.1,  1540.3,  1504.0,  1535.4,  1533.4
"""


def get_runs_mean(data: str) -> float:

    medians: list[float] = []

    for line in data.strip().splitlines():
        try:
            numbers = [float(p.strip()) for p in line.split(",")]
        except ValueError:
            # We have reached the === line
            # print(f"Could not convert line '{line}' to numbers")
            break

        medians.append(statistics.median(numbers))

    return statistics.geometric_mean(medians)

def get_overhead(mit: str, base: str) -> float:
    mean_base = get_runs_mean(base)
    mean_mit = get_runs_mean(mit)
    print(f"Baseline: {mean_base}")
    print(f"Mitigated: {mean_mit}")


    overhead = ((mean_base / mean_mit) - 1) * 100

    # print(f"Overhead: {(1 - (mean_mit / mean_base)) * 100}")
    return overhead

print(f"Overhead VMEXIT: {get_overhead(vmexit_ibpb, vmexit_baseline)}")
print(f"Overhead retpoline: {get_overhead(qemu_retpoline, qemu_baseline)}")
